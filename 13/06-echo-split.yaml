# 06-echo-split.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: echo-v1
  namespace: sd-lab
spec:
  replicas: 1
  selector:
    matchLabels: { app: echo, version: v1 }
  template:
    metadata:
      labels: { app: echo, version: v1 }
    spec:
      containers:
        - name: echo
          image: hashicorp/http-echo:1.0
          args: ["-text=echo-v1"]
          ports: [{containerPort: 5678}]
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: echo-v2
  namespace: sd-lab
spec:
  replicas: 1
  selector:
    matchLabels: { app: echo, version: v2 }
  template:
    metadata:
      labels: { app: echo, version: v2 }
    spec:
      containers:
        - name: echo
          image: hashicorp/http-echo:1.0
          args: ["-text=echo-v2"]
          ports: [{containerPort: 5678}]
---
apiVersion: v1
kind: Service
metadata:
  name: echo-mesh
  namespace: sd-lab
spec:
  selector:
    app: echo
  ports:
    - name: http
      port: 80
      targetPort: 5678
---
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: echo
  namespace: sd-lab
spec:
  host: echo-mesh
  subsets:
    - name: v1
      labels: { version: v1 }
    - name: v2
      labels: { version: v2 }
---
apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  name: echo
  namespace: sd-lab
spec:
  hosts: ["echo-mesh"]
  http:
    - route:
        - destination: { host: echo-mesh, subset: v1 }
          weight: 80
        - destination: { host: echo-mesh, subset: v2 }
          weight: 20

