# 기본 Sidecar 패턴 예제
# HTTP 서버와 Git 동기화 사이드카를 사용하는 Pod
apiVersion: v1
kind: Pod
metadata:
  name: web-app-basic
  labels:
    app: web-server
    pattern: sidecar
spec:
  containers:
  # 메인 애플리케이션 컨테이너
  - name: app
    image: nginx:1.27
    ports:
    - containerPort: 80
      name: http
    volumeMounts:
    - mountPath: /usr/share/nginx/html
      name: git-content
    resources:
      requests:
        memory: "64Mi"
        cpu: "100m"
      limits:
        memory: "128Mi"
        cpu: "200m"

  # Sidecar 컨테이너: Git 동기화
  - name: git-sync
    image: registry.k8s.io/git-sync/git-sync:v4.3.0
    volumeMounts:
    - mountPath: /tmp/git
      name: git-content
    env:
    - name: GITSYNC_REPO
      value: "https://github.com/kubernetes/website"
    - name: GITSYNC_ROOT
      value: "/tmp/git"
    - name: GITSYNC_LINK
      value: "current"
    - name: GITSYNC_PERIOD
      value: "60s"  # 60초마다 동기화
    - name: GITSYNC_ONE_TIME
      value: "false"
    resources:
      requests:
        memory: "64Mi"
        cpu: "50m"
      limits:
        memory: "128Mi"
        cpu: "100m"

  volumes:
  - name: git-content
    emptyDir: {}

---
# Service를 통해 웹 서버 노출
apiVersion: v1
kind: Service
metadata:
  name: web-app-service
spec:
  selector:
    app: web-server
  ports:
  - protocol: TCP
    port: 80
    targetPort: 80
  type: ClusterIP
